<button
    type="button"
    id="toggle-hidden-btn"
    onclick="toggleHiddenItems()"
    title="<%= showHidden ? 'Hide private ' + itemType : 'Show private ' + itemType %>"
    aria-label="<%= showHidden ? 'Hide private ' + itemType : 'Show private ' + itemType %>"
>
    <%= showHidden ? 'üîì' : 'üîí' %>
</button>

<dialog id="hidden-password-modal" aria-labelledby="hidden-password-title">
    <h2 id="hidden-password-title">üîí Verify Password</h2>
    <p>Enter your hidden items password to view private <%= itemType %>.</p>
    <form method="POST" action="/verify-hidden-password">
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
        <% const currentUrl = new URL('http://localhost' + path); %>
        <% if (search) currentUrl.searchParams.set('search', search); %>
        <% if (pagination.currentPage) currentUrl.searchParams.set('page', pagination.currentPage); %>
        <% if (pagination.perPage) currentUrl.searchParams.set('per_page', pagination.perPage); %>
        <% if (sortKey) currentUrl.searchParams.set('sort_key', sortKey); %>
        <% if (direction) currentUrl.searchParams.set('direction', direction); %>
        <% currentUrl.searchParams.set('hidden', 'true'); %>
        <input type="hidden" name="redirect_url" value="<%= currentUrl.pathname + currentUrl.search %>" />
        <%- include('./inputs/password.html', {
            id: 'hidden-password-input',
            name: 'password',
            label: 'Password',
            placeholder: 'Enter password...',
            required: true,
            error: state.flash && state.flash.error && state.flash.error.length > 0 ? state.flash.error[0] : undefined
        }) %>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" onclick="document.getElementById('hidden-password-modal').close()">‚ùå Cancel</button>
            <button type="submit">üîì Verify</button>
        </div>
    </form>
</dialog>

<script>
    function toggleHiddenItems() {
        const showHidden = <%= showHidden ? 'true' : 'false' %>;
        const hiddenItemsVerified = <%= hiddenItemsVerified ? 'true' : 'false' %>;

        if (!showHidden && !hiddenItemsVerified) {
            document.getElementById('hidden-password-modal').showModal();
        } else {
            const currentUrl = new URL(window.location.href);
            if (showHidden) {
                currentUrl.searchParams.delete('hidden');
            } else {
                currentUrl.searchParams.set('hidden', 'true');
            }
            window.location.href = currentUrl.toString();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('verify-password-modal') === 'true') {
            document.getElementById('hidden-password-modal').showModal();
            urlParams.delete('verify-password-modal');
            const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
            history.replaceState({}, document.title, newUrl);
        }
    });
</script>
