<section style="display: flex; flex-direction: column; gap: 30px;">
  <header style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2>👥 Users (<%- pagination.total %>)</h2>
      <p>Manage application users</p>
    </div>

    <nav style="display: flex; gap: 10px;" aria-label="User management controls">
      <% if (search) { %>
        <button class="no-style-btn" type="button" onclick="location.href='/admin/users'">❌ Clear</button>
      <% } %>

      <form method="GET" style="display: flex; gap: 10px;" role="search">
        <%- include('../_components/inputs/search.html', {
          id: 'search-input',
          name: 'search',
          label: 'Search users',
          placeholder: 'Search users...',
          value: search,
          required: false,
          helpText: 'Search for users by username or email',
          error: state.errors && state.errors.search ? state.errors.search : undefined
        }) %>
        <button type="submit">🔍</button>
      </form>

      <button type="button" id="delete-selected-btn" style="display: none;" aria-label="Delete selected users">🗑️</button>

      <%- include('../_components/column-settings.html') %>

    </nav>
  </header>

  <div style="display: flex; flex-direction: column; gap: 10px;">
    <% if (data && data.length > 0) { %>
      <table style="width: 100%; border-collapse: collapse;">
        <caption style="position: absolute; left: -10000px;"><%= data.length %> users found</caption>
        <thead>
          <tr>
            <th scope="col" style="text-align: left; padding: 10px; width: 40px;">
              <input type="checkbox" id="select-all-checkbox" aria-label="Select all users" />
            </th>
            <% if (state.user.column_preferences?.users?.username !== false) { %>
            <th scope="col" style="text-align: left; padding: 10px;">
              <a href="/admin/users?page=<%= pagination.currentPage %>&per_page=<%= pagination.perPage %>&sort_key=username&direction=<%= (sortKey === 'username' && direction === 'asc') ? 'desc' : 'asc' %>&search=<%= search %>"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px;">
                👤 Username
                <% if (sortKey === 'username') { %>
                  <%= direction === 'asc' ? '🔼' : '🔽' %>
                <% } else { %>
                  <span class="sort-icon">⏺️</span>
                <% } %>
              </a>
            </th>
            <% } %>
            <% if (state.user.column_preferences?.users?.email !== false) { %>
            <th scope="col" style="text-align: left; padding: 10px;">
              <a href="/admin/users?page=<%= pagination.currentPage %>&per_page=<%= pagination.perPage %>&sort_key=email&direction=<%= (sortKey === 'email' && direction === 'asc') ? 'desc' : 'asc' %>&search=<%= search %>"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px;">
                📧 Email
                <% if (sortKey === 'email') { %>
                  <%= direction === 'asc' ? '🔼' : '🔽' %>
                <% } else { %>
                  <span class="sort-icon">⏺️</span>
                <% } %>
              </a>
            </th>
            <% } %>
            <% if (state.user.column_preferences?.users?.is_admin !== false) { %>
            <th scope="col" style="text-align: left; padding: 10px;">
              <a href="/admin/users?page=<%= pagination.currentPage %>&per_page=<%= pagination.perPage %>&sort_key=is_admin&direction=<%= (sortKey === 'is_admin' && direction === 'asc') ? 'desc' : 'asc' %>&search=<%= search %>"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px;">
                👑 Admin
                <% if (sortKey === 'is_admin') { %>
                  <%= direction === 'asc' ? '🔼' : '🔽' %>
                <% } else { %>
                  <span class="sort-icon">⏺️</span>
                <% } %>
              </a>
            </th>
            <% } %>
            <% if (state.user.column_preferences?.users?.email_verified_at !== false) { %>
            <th scope="col" style="text-align: left; padding: 10px;">
              <a href="/admin/users?page=<%= pagination.currentPage %>&per_page=<%= pagination.perPage %>&sort_key=email_verified_at&direction=<%= (sortKey === 'email_verified_at' && direction === 'asc') ? 'desc' : 'asc' %>&search=<%= search %>"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px;">
                ✅ Email Verified
                <% if (sortKey === 'email_verified_at') { %>
                  <%= direction === 'asc' ? '🔼' : '🔽' %>
                <% } else { %>
                  <span class="sort-icon">⏺️</span>
                <% } %>
              </a>
            </th>
            <% } %>
            <% if (state.user.column_preferences?.users?.created_at !== false) { %>
            <th scope="col" style="text-align: left; padding: 10px;">
              <a href="/admin/users?page=<%= pagination.currentPage %>&per_page=<%= pagination.perPage %>&sort_key=created_at&direction=<%= (sortKey === 'created_at' && direction === 'asc') ? 'desc' : 'asc' %>&search=<%= search %>"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px;">
                📅 Created
                <% if (sortKey === 'created_at') { %>
                  <%= direction === 'asc' ? '🔼' : '🔽' %>
                <% } else { %>
                  <span class="sort-icon">⏺️</span>
                <% } %>
              </a>
            </th>
            <% } %>
            <th scope="col" style="text-align: left; padding: 10px;">🚀 Actions</th>
          </tr>
        </thead>
        <tbody>
          <% data.forEach(function(user) { %>
            <tr>
              <td style="padding: 10px;">
                <input
                  type="checkbox"
                  name="id[]"
                  value="<%- user.id %>"
                  class="user-checkbox"
                  data-username="<%- utils.stripHtmlTags(user.username || 'Unknown User') %>"
                  <%= user.is_admin ? 'disabled title="Cannot delete admin users"' : '' %>
                />
              </td>
              <% if (state.user.column_preferences?.users?.username !== false) { %>
                <td style="padding: 10px;"><%- utils.highlightSearchTerm(user.username, search) %></td>
              <% } %>
              <% if (state.user.column_preferences?.users?.email !== false) { %>
                <td style="padding: 10px;"><%- utils.highlightSearchTerm(user.email, search) %></td>
              <% } %>
              <% if (state.user.column_preferences?.users?.is_admin !== false) { %>
                <td style="padding: 10px;"><%= user.is_admin ? '✅' : '❌' %></td>
              <% } %>
              <% if (state.user.column_preferences?.users?.email_verified_at !== false) { %>
                <td style="padding: 10px;"><%= user.email_verified_at ? '✅' : '❌' %></td>
              <% } %>
              <% if (state.user.column_preferences?.users?.created_at !== false) { %>
                <td style="padding: 10px;">
                  <time datetime="<%= user.created_at %>">
                    <%= utils.formatDateInTimezone(user.created_at, state.user.timezone).fullString %>
                  </time>
                </td>
              <% } %>
              <td style="padding: 10px;">
                <div style="display: flex; gap: 10px;">
                  <button
                      type="button"
                      class="no-style-btn"
                      onclick="showDeleteUserModal('<%= user.id %>', '<%= utils.stripHtmlTags(user.username || 'Unknown User').replace(/'/g, '\\\'') %>')"
                      aria-label="Delete user <%= utils.stripHtmlTags(user.username) %>"
                  >
                    🗑️ Delete
                  </button>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } else { %>
      <div style="text-align: center; padding: 20px;">
        <% if (search) { %>
          <p>🔍 No users found matching "<%= search %>"</p>
          <p>Try a different search term or <a href="/admin/users">view all users</a></p>
        <% } else { %>
          <p>📭 No users found.</p>
        <% } %>
      </div>
    <% } %>
  </div>

  <%- include('../_components/pagination.html', {
    pagination,
    path,
    perPageDefault: state.user.column_preferences.users.default_per_page,
    sortKey,
    direction,
    search,
  }) %>

  <dialog id="delete-user-modal" aria-labelledby="delete-user-title">
    <h2 id="delete-user-title">Confirm</h2>
    <p>Are you sure you want to delete user <strong id="delete-user-name"></strong>?</p>
    <form id="delete-user-form" method="POST">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="document.getElementById('delete-user-modal').close()">❌ Cancel</button>
        <button type="submit">🗑️ Delete</button>
      </div>
    </form>
  </dialog>

  <dialog id="delete-selected-modal" aria-labelledby="delete-selected-title">
    <h2 id="delete-selected-title">Confirm Bulk Delete</h2>
    <p>Are you sure you want to delete the following users?</p>
    <div id="selected-users-list" style="display: flex; flex-direction: column; gap: 5px; margin: 10px 0;"></div>
    <form action="/admin/users/delete" method="POST">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <div id="bulk-delete-checkboxes"></div>
      <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="document.getElementById('delete-selected-modal').close()">❌ Cancel</button>
        <button type="submit">🗑️ Delete</button>
      </div>
    </form>
  </dialog>

  <style>
    section:has(.user-checkbox:checked) #delete-selected-btn {
      display: inline-block !important;
    }
  </style>

  <script>
    function showDeleteUserModal(userId, username) {
      const modal = document.getElementById('delete-user-modal');
      const nameElement = document.getElementById('delete-user-name');
      const form = document.getElementById('delete-user-form');
      nameElement.textContent = username;
      form.action = `/admin/users/${userId}/delete`;
      modal.showModal();
    }

    document.getElementById('select-all-checkbox')?.addEventListener('change', function() {
      document.querySelectorAll('.user-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = this.checked;
      });
    });

    document.getElementById('delete-selected-btn')?.addEventListener('click', function() {
      const checked = [...document.querySelectorAll('.user-checkbox:checked')];

      if (!checked.length) {
        return;
      }

      document.getElementById('selected-users-list').innerHTML = checked
        .map(cb => `<span>- <strong>${cb.dataset.username}</strong></span>`)
        .join('');

      document.getElementById('bulk-delete-checkboxes').innerHTML = checked
        .map(cb => `<input type="hidden" name="id[]" value="${cb.value}">`)
        .join('');

      document.getElementById('delete-selected-modal').showModal();
    });
  </script>
</section>
