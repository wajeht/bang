<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const input = document.getElementById('q');
    const dropdown = document.getElementById('bangsDropdown');
    let bangs = [];
    let selectedIndex = -1;

    try {
      const response = await fetch('/actions', { headers: { 'Content-Type': 'application/json' } });
      bangs = (await response.json()).data;
    } catch (error) {
      console.error('Error fetching bangs:', error);
    }

    function submitBang(bangTrigger) {
      input.value = bangTrigger;
      dropdown.style.display = 'none';
      input.form.submit();
    }

    function updateSelection(index) {
      const items = dropdown.querySelectorAll('li');
      items.forEach(item => item.classList.remove('selected'));

      if (index >= 0 && index < items.length) {
        selectedIndex = index;
        items[index].classList.add('selected');
        items[index].scrollIntoView({ block: 'nearest' });
      }
    }

    input.addEventListener('keydown', (e) => {
      const items = dropdown.querySelectorAll('li');
      if (!items.length || dropdown.style.display === 'none') return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        updateSelection((selectedIndex + 1) % items.length);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        updateSelection((selectedIndex - 1 + items.length) % items.length);
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        submitBang(items[selectedIndex].textContent.split(' - ')[0].trim());
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
        selectedIndex = -1;
      }
    });

    input.addEventListener('input', (e) => {
      const value = e.target.value;
      selectedIndex = -1;
      dropdown.style.display = value.startsWith('!') ? 'block' : 'none';

      const matches = bangs.filter(bang => bang.trigger.startsWith(value));
      dropdown.innerHTML = matches
        .map(bang => `<li>${bang.trigger} - ${bang.name}</li>`)
        .join('');

      dropdown.querySelectorAll('li').forEach(item => {
        item.onclick = () => submitBang(item.textContent.split(' - ')[0].trim());
      });
    });

    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
        selectedIndex = -1;
      }
    });
  });
</script>

<div style="margin-top: 30%; display: flex; justify-content: center; align-items: center; width: 100%;">
  <form method="POST" action="/search" style="display: flex; gap: 5px; width: 45%; position: relative;">
    <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />
    <input type="text" name="q" id="q" placeholder="Search..." required autofocus style="width: 100%;">
    <ul id="bangsDropdown" style="position: absolute; top: 50px; left: 0; width: 100%; background: white; border: 1px dashed #ccc; border-radius: 5px; list-style: none; padding: 0; margin: 0; display: none; z-index: 10;"></ul>
    <button type="submit">Search</button>
  </form>
</div>

<style>
  #bangsDropdown li.selected {
    background-color: #f0f0f0;
  }
</style>
