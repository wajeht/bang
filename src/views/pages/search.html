<script>
  async function getActionsAndBookmarks() {
    try {
      const response = await fetch('/api/actions-and-bookmarks?per_page=999999999999', {
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      return {
        actions: data.actions.data,
        bookmarks: data.bookmarks.data
      };
    } catch (error) {
      console.error('Error fetching actions and bookmarks:', error);
      return { actions: [], bookmarks: [] };
    }
  }

  function submitBang(bangTrigger, input, dropdown) {
    input.value = bangTrigger;
    dropdown.style.display = 'none';
    input.form.submit();
  }

  function updateSelection(index, dropdown, input, selectedIndex, updateInputValue = false) {
    const items = dropdown.querySelectorAll('li');
    items.forEach(item => item.classList.remove('selected'));

    if (index >= 0 && index < items.length) {
      selectedIndex = index;
      const selectedItem = items[index];
      selectedItem.classList.add('selected');
      selectedItem.scrollIntoView({ block: 'nearest' });

      if (updateInputValue) {
        const bangTrigger = selectedItem.textContent.split(' - ')[0].trim();
        input.value = bangTrigger;
      }
    }

    return selectedIndex;
  }

  function handleKeyboardNavigation(e, dropdown, input, selectedIndex) {
    const items = dropdown.querySelectorAll('li');
    if (!items.length || dropdown.style.display === 'none') return selectedIndex;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        return updateSelection(
          selectedIndex < items.length - 1 ? selectedIndex + 1 : 0,
          dropdown,
          input,
          selectedIndex,
          true
        );
      case 'ArrowUp':
        e.preventDefault();
        return updateSelection(
          selectedIndex > 0 ? selectedIndex - 1 : items.length - 1,
          dropdown,
          input,
          selectedIndex,
          true
        );
      case 'Enter':
        if (selectedIndex >= 0) {
          e.preventDefault();
          const bangTrigger = items[selectedIndex].textContent.split(' - ')[0].trim();
          submitBang(bangTrigger, input, dropdown);
        }
        return selectedIndex;
      case 'Escape':
        dropdown.style.display = 'none';
        return -1;
      default:
        return selectedIndex;
    }
  }

  function handleInputChange(e, data, dropdown, input, selectedIndex) {
    const value = e.target.value.trim();

    if (value.startsWith('!')) {
      // Bang search logic
      const matches = data.actions.filter(action =>
        action.trigger.toLowerCase().startsWith(value.toLowerCase())
      );

      if (!matches.length) {
        dropdown.style.display = 'none';
        return -1;
      }

      dropdown.innerHTML = matches
        .map(action => `
          <li style="padding: 5px 10px; cursor: pointer;">
            <span style="font-weight: bold;">${action.trigger}</span> - ${action.name}
          </li>
        `)
        .join('');
    } else if (value) {
      // General search logic
      const actionMatches = data.actions.filter(action =>
        action.name.toLowerCase().includes(value.toLowerCase())
      );

      const bookmarkMatches = data.bookmarks.filter(bookmark =>
        bookmark.title.toLowerCase().includes(value.toLowerCase())
      );

      if (!actionMatches.length && !bookmarkMatches.length) {
        dropdown.style.display = 'none';
        return -1;
      }

      dropdown.innerHTML = [
        ...actionMatches.map(action => `
          <li style="padding: 5px 10px; cursor: pointer;">
            <span style="font-weight: bold;">Action:</span> ${action.name}
          </li>
        `),
        ...bookmarkMatches.map(bookmark => `
          <li style="padding: 5px 10px; cursor: pointer;">
            <span style="font-weight: bold;">Bookmark:</span> ${bookmark.title}
          </li>
        `)
      ].join('');
    } else {
      dropdown.style.display = 'none';
      return -1;
    }

    dropdown.style.display = 'block';

    dropdown.querySelectorAll('li').forEach((item, index) => {
      item.onclick = () => {
        const text = item.textContent.trim();
        if (text.startsWith('Action:')) {
          // Handle action click
          const actionName = text.replace('Action:', '').trim();
          const action = data.actions.find(a => a.name === actionName);
          if (action) {
            submitBang(action.trigger, input, dropdown);
          }
        } else {
          // Handle bookmark click
          const bookmarkTitle = text.replace('Bookmark:', '').trim();
          const bookmark = data.bookmarks.find(b => b.title === bookmarkTitle);
          if (bookmark) {
            window.location.href = bookmark.url;
          }
        }
      };

      item.onmouseover = () => {
        selectedIndex = updateSelection(index, dropdown, input, selectedIndex, false);
        input.focus();
      };
    });

    return -1;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const input = document.getElementById('q');
    const dropdown = document.getElementById('bangsDropdown');
    let data = { actions: [], bookmarks: [] };
    let selectedIndex = -1;

    // Fetch combined data
    data = await getActionsAndBookmarks();

    // Set up event listeners
    input.addEventListener('keydown', (e) => selectedIndex = handleKeyboardNavigation(e, dropdown, input, selectedIndex));
    input.addEventListener('input', (e) => selectedIndex = handleInputChange(e, data, dropdown, input, selectedIndex));

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
        selectedIndex = -1;
      }
    });

    // Add global keyboard shortcut
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        input.focus();
      }
    });

  });
</script>

<div style="margin-top: 30%; display: flex; justify-content: center; align-items: center; width: 100%;">
  <form method="POST" action="/search" style="display: flex; gap: 5px; width: 45%; position: relative;">
    <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />
    <input type="search" name="q" id="q" placeholder="Search..." required autofocus style="width: 100%;">
    <ul id="bangsDropdown" style="position: absolute; top: 50px; left: 0; width: 100%; background: var(--background-color); border: 1px dashed var(--border-color); border-radius: 3px; list-style: none; padding: 0; margin: 0; display: none; z-index: 10; max-height: 350px; overflow-y: auto;"></ul>
    <button type="submit">ðŸ”Ž</button>
  </form>
</div>

<style>
  [data-theme='dark'] #bangsDropdown li.selected {
    background-color: var(--button-background);
  }

  [data-theme='dark'] #bangsDropdown li:hover {
    background-color: var(--button-background);
  }

  #bangsDropdown li.selected {
    background-color: #f0f0f0;
  }

  #bangsDropdown li:hover {
    background-color: #f0f0f0;
  }
</style>
