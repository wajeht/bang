<script>
  function viewApiKey() {
    const apiKeyPre = document.getElementById('apiKeyPre');
    const viewOrHideButton = document.getElementById('view-or-hide-button');
    if (apiKeyPre.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
      apiKeyPre.textContent = '<%= user.api_key %>';
      viewOrHideButton.textContent = 'ğŸ‘ï¸ Hide';
    } else {
      apiKeyPre.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
      viewOrHideButton.textContent = 'ï¸ğŸ‘ï¸ View';
    }
  }

  function copyApiKey() {
    const apiKey = '<%= user.api_key %>';
    navigator.clipboard.writeText(apiKey).then(() => {
      createToast('ğŸ”‘ API key copied to clipboard!')
    });
  }
</script>

<section style="display: flex; flex-direction: column; gap: 20px; max-width: 100%;">

  <header style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <div style="display: flex; flex-direction: column; gap: 5px;">
        <h2 style="margin: 0;">ğŸ‘¤ Account</h2>
        <p>Manage your account details.</p>
      </div>
  </header>

  <form action="/settings/account" method="POST" >
    <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />

    <fieldset style="width: 32.5%; max-width: 32.5%; min-width: 0; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px;">
      <legend>Account Information</legend>

      <div style="display: flex; flex-direction: column; gap: 5px;">
        <label for="username">ğŸ‘¤ Username <abbr title="Required">*</abbr></label>
        <input type="text" id="username" name="username" value="<%= state.input.username ?? user.username %>" required aria-describedby="username-help <%= state.errors.username ? 'username-error' : '' %>">
        <small id="username-help">Your unique username</small>
        <% if (state.errors.username) { %>
          <small id="username-error" style="color: red;" role="alert"><%= state.errors.username %></small>
        <% } %>
      </div>

      <div style="display: flex; flex-direction: column; gap: 5px;">
        <label for="email">ğŸ“§ Email <abbr title="Required">*</abbr></label>
        <input type="email" id="email" name="email" value="<%= state.input.email ?? user.email %>" required aria-describedby="email-help <%= state.errors.email ? 'email-error' : '' %>">
        <small id="email-help">Your email address for login and notifications</small>
        <% if (state.errors.email) { %>
          <small id="email-error" style="color: red;" role="alert"><%= state.errors.email %></small>
        <% } %>
      </div>

      <div style="display: flex; flex-direction: column; gap: 5px;">
        <label for="default_search_provider">ğŸ” Default Search Provider <abbr title="Required">*</abbr></label>
        <select id="default_search_provider" name="default_search_provider" required aria-describedby="search-provider-help <%= state.errors.default_search_provider ? 'search-provider-error' : '' %>">
            <% defaultSearchProviders.forEach(provider => { %>
                <option value="<%= provider %>" <%= (state.input.default_search_provider ?? user.default_search_provider) === provider ? 'selected' : '' %> >
                    <%= provider.charAt(0).toUpperCase() + provider.slice(1) %>
                </option>
            <% }); %>
        </select>
        <small id="search-provider-help">Your preferred search engine for queries</small>
        <% if (state.errors.default_search_provider) { %>
          <small id="search-provider-error" style="color: red;" role="alert"><%= state.errors.default_search_provider %></small>
        <% } %>
      </div>

      <div style="display: flex; flex-direction: column; gap: 5px;">
        <label>
          <input
            type="checkbox"
            name="autocomplete_search_on_homepage"
            <%= user.autocomplete_search_on_homepage ? 'checked' : '' %>
            aria-describedby="autocomplete-help <%= state.errors.autocomplete_search_on_homepage ? 'autocomplete-error' : '' %>">
          Autocomplete Search on Homepage
        </label>
        <small id="autocomplete-help">Enable search suggestions on the homepage</small>
        <% if (state.errors.autocomplete_search_on_homepage) { %>
          <small id="autocomplete-error" style="color: red;" role="alert"><%= state.errors.autocomplete_search_on_homepage %></small>
        <% } %>
      </div>

      <button type="submit">ğŸ’¾ Save</button>
    </fieldset>
  </form>

  <fieldset style="width: 32.5%; max-width: 32.5%; min-width: 0; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px;">
    <legend>ğŸ”‘ API Key <% if (user.api_key_version > 0) { %>(v<%= user.api_key_version %>)<% } %></legend>

    <% if (user.api_key) { %>
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; min-width: 0; flex-wrap: wrap;">
          <button type="button" onclick="viewApiKey()" class="no-style-btn" id="view-or-hide-button" aria-describedby="api-key-display" style="flex-shrink: 0;">ğŸ‘ï¸ View</button>
          <button type="button" onclick="copyApiKey()" class="no-style-btn" style="flex-shrink: 0;">ğŸ“‹ Copy</button>
          <a href="/api-docs" target="_blank" rel="noopener noreferrer" style="flex-shrink: 0;">ğŸ“ƒ Docs</a>
      </div>
    <% } %>

    <pre id="apiKeyPre" aria-live="polite" aria-label="API Key display" style="white-space: nowrap; overflow-x: auto; padding: 8px; max-width: 100%; box-sizing: border-box;"><% if (!user.api_key) { %>click to generate api key<% } else { %>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢<% } %></pre>

    <% if (user.api_key_version > 0) {  %>
      <button type="button" onclick="document.getElementById('regenerate-modal').showModal()">ğŸ”„ Regenerate</button>
      <dialog id="regenerate-modal" aria-labelledby="regenerate-title">
        <h2 id="regenerate-title">ğŸ”„ Regenerate</h2>
        <p>This action will invalidate the current key. Are you sure you want to generate a new API key?</p>
        <form action="/settings/create-api-key" method="post">
          <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" onclick="this.closest('dialog').close()">âŒ Cancel</button>
            <button type="submit">ğŸ”„ Regenerate</button>
          </div>
        </form>
      </dialog>
    <% } else { %>
      <form action="/settings/create-api-key" method="post">
        <input type="hidden" id="csrfToken" name="csrfToken" value="<%= csrfToken %>" />
        <button type="submit">â• Generate</button>
      </form>
    <% } %>

    <% if (user.api_key_created_at) { %>
      <small style="color: #bbb;">Created: <time datetime="<%= user.api_key_created_at %>"><%= new Date(user.api_key_created_at).toLocaleString() %></time></small>
    <% } %>
  </fieldset>

</section>
